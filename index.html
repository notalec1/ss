<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Number Line Game</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --error: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            background: var(--card);
            width: 100%;
            max-width: 550px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1, h2, h3 { margin: 0; text-align: center; }
        h1 { color: var(--primary); font-size: 1.8rem; }
        p { color: #64748b; text-align: center; line-height: 1.5; margin: 0; }

        /* Controls */
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            flex: 1;
            font-weight: bold;
            font-size: 0.9rem;
            color: #475569;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
        }
        
        input:focus { border-color: var(--primary); }

        /* Buttons */
        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        
        button:hover:not(:disabled) { transform: translateY(-1px); background-color: var(--primary-dark); }
        button:active:not(:disabled) { transform: translateY(0); }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        
        button.secondary { background-color: #f1f5f9; color: #475569; box-shadow: none; border: 1px solid #e2e8f0; }
        button.secondary:hover { background-color: #e2e8f0; }
        
        button.icon-btn { width: 40px; height: 40px; padding: 0; font-size: 1.2rem; }
        button.sm-btn { width: auto; padding: 8px 16px; font-size: 0.9rem; }

        /* Lists */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-item.correct { border-color: var(--success); background-color: #f0fdf4; }
        .card-item.wrong { border-color: var(--error); background-color: #fef2f2; }

        .big-number {
            font-size: 5rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 0px #e2e8f0;
        }

        .move-controls { display: flex; gap: 4px; }
        
        /* Utility */
        .hidden { display: none; }
        .badge { 
            background: #e0f2fe; color: #0369a1; 
            padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;
        }
        
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #334155; color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
    </style>
</head>
<body>

    <div class="app-container" id="app">
        <!-- JS will render content here -->
    </div>
    
    <div id="toast">Copied to clipboard!</div>

    <script>
        // --- DATA & STATE ---
        let state = {
            step: 'SETUP', // SETUP, DISTRIBUTE, VERIFY, RESULTS
            players: [],   // { name, number }
            settings: {
                min: 1,
                max: 200,
                order: 'asc' // 'asc' or 'desc'
            }
        };

        const app = document.getElementById('app');

        // --- UTILS ---
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        };

        const encodeData = (obj) => btoa(JSON.stringify(obj));
        const decodeData = (str) => {
            try { return JSON.parse(atob(str)); } catch(e) { return null; }
        };

        // --- RENDER FUNCTIONS ---

        function render() {
            // Check if URL has player data (Player View)
            const params = new URLSearchParams(window.location.search);
            if (params.get('p')) {
                renderPlayerView(params.get('p'));
                return;
            }

            // Otherwise, render Host View based on step
            switch (state.step) {
                case 'SETUP': renderSetup(); break;
                case 'DISTRIBUTE': renderDistribute(); break;
                case 'VERIFY': renderVerify(); break;
                case 'RESULTS': renderResults(); break;
            }
        }

        // 1. SETUP SCREEN
        function renderSetup() {
            app.innerHTML = `
                <h1>üî¢ Number Line</h1>
                <p>Configure your game settings.</p>
                
                <div class="control-group" style="flex-direction: column; gap:0;">
                    <div style="display:flex; gap:10px;">
                        <div>
                            <label>Min</label>
                            <input type="number" id="minInput" value="${state.settings.min}">
                        </div>
                        <div>
                            <label>Max</label>
                            <input type="number" id="maxInput" value="${state.settings.max}">
                        </div>
                    </div>
                </div>

                <div>
                    <label style="font-size:0.9rem; font-weight:bold;">Ranking Order</label>
                    <select id="orderInput">
                        <option value="asc" ${state.settings.order === 'asc' ? 'selected' : ''}>Smallest ‚Üí Biggest</option>
                        <option value="desc" ${state.settings.order === 'desc' ? 'selected' : ''}>Biggest ‚Üí Smallest</option>
                    </select>
                </div>

                <div style="border-top: 1px solid #e2e8f0; margin: 10px 0;"></div>

                <div>
                    <label style="font-size:0.9rem; font-weight:bold;">Add Players</label>
                    <div style="display:flex; gap:8px; margin-top:5px;">
                        <input type="text" id="nameInput" placeholder="Name (e.g. Mom)" onkeydown="if(event.key==='Enter') addPlayer()">
                        <button class="sm-btn" onclick="addPlayer()">Add</button>
                    </div>
                </div>

                <div class="list-container">
                    ${state.players.map((p, i) => `
                        <div class="card-item">
                            <span>${p.name}</span>
                            <button class="icon-btn secondary" style="color:#ef4444" onclick="removePlayer(${i})">√ó</button>
                        </div>
                    `).join('')}
                </div>

                <button onclick="startGame()" ${state.players.length < 2 ? 'disabled' : ''}>
                    Generate Numbers & Start
                </button>
            `;
        }

        // 2. DISTRIBUTE LINKS SCREEN
        function renderDistribute() {
            const baseUrl = window.location.href.split('?')[0];
            
            app.innerHTML = `
                <h1>üîó Distribute Numbers</h1>
                <p>Send links to players so they can see their secret numbers.</p>
                
                <div class="list-container">
                    ${state.players.map(p => {
                        // Encode payload: name, number, min, max, order
                        const payload = { 
                            n: p.name, 
                            v: p.number, 
                            min: state.settings.min,
                            max: state.settings.max,
                            o: state.settings.order 
                        };
                        const link = `${baseUrl}?p=${encodeData(payload)}`;
                        
                        return `
                        <div class="card-item" style="display:block;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <strong>${p.name}</strong>
                                <span class="badge">HIDDEN</span>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="secondary sm-btn" onclick="navigator.clipboard.writeText('${link}'); showToast('Link for ${p.name} copied')">Copy Link</button>
                                <button class="secondary sm-btn" onclick="window.open('${link}', '_blank')">Open</button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>

                <div style="text-align:center; padding-top:20px; border-top:1px solid #e2e8f0;">
                    <p style="margin-bottom:10px;">Once everyone has their number and is standing in line...</p>
                    <button onclick="setState('VERIFY')">Start Verification Phase</button>
                </div>
            `;
        }

        // 3. VERIFICATION SCREEN (Host arranges visual list)
        function renderVerify() {
            const orderText = state.settings.order === 'asc' ? 'Smallest to Biggest' : 'Biggest to Smallest';
            
            app.innerHTML = `
                <h2>üßê Verification</h2>
                <p>Look at the family line-up.<br>Arrange the names below to match <strong>exactly</strong> how they are standing.</p>
                <div class="badge" style="align-self:center; margin-bottom:10px;">Goal: ${orderText}</div>

                <div class="list-container">
                    ${state.players.map((p, i) => `
                        <div class="card-item">
                            <strong>${p.name}</strong>
                            <div class="move-controls">
                                <button class="icon-btn secondary" onclick="movePlayer(${i}, -1)" ${i === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                <button class="icon-btn secondary" onclick="movePlayer(${i}, 1)" ${i === state.players.length - 1 ? 'disabled' : ''}>‚ñº</button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <button style="margin-top:20px; background-color: var(--success);" onclick="checkOrder()">Check Correctness</button>
                <button class="secondary" style="margin-top:10px;" onclick="setState('DISTRIBUTE')">Go Back</button>
            `;
        }

        // 4. RESULTS SCREEN
        function renderResults() {
            // Calculate correct sorted order for logic
            const sortedPlayers = [...state.players].sort((a, b) => {
                return state.settings.order === 'asc' ? a.number - b.number : b.number - a.number;
            });

            // Compare state.players (user arrangement) vs sortedPlayers
            let allCorrect = true;
            
            const resultsHTML = state.players.map((p, i) => {
                // To check correctness, we check if the person at index i
                // is the same person who SHOULD be at index i
                const correctPerson = sortedPlayers[i];
                const isCorrect = p.name === correctPerson.name; // ID check would be better but names work for simple game
                
                if (!isCorrect) allCorrect = false;

                return `
                    <div class="card-item ${isCorrect ? 'correct' : 'wrong'}">
                        <div>
                            <strong>${p.name}</strong>
                            <div style="font-size:0.8rem; color:#64748b;">Has number: <strong>${p.number}</strong></div>
                        </div>
                        <div style="text-align:right;">
                            ${isCorrect ? '‚úÖ Correct' : '‚ùå Wrong'}
                            ${!isCorrect ? `<div style="font-size:0.7rem; color:#ef4444">Should be #${sortedPlayers.findIndex(x => x.name === p.name) + 1}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <h1>${allCorrect ? 'üéâ Perfect!' : 'üëÄ Close!'}</h1>
                <p>${allCorrect ? 'The family is in the correct order!' : 'Some people are in the wrong spot.'}</p>
                
                <div class="list-container">
                    ${resultsHTML}
                </div>

                <button style="margin-top:20px;" onclick="location.reload()">New Game</button>
            `;
        }

        // 5. PLAYER VIEW (What they see on phone)
        function renderPlayerView(encodedData) {
            const data = decodeData(encodedData);
            if (!data) {
                app.innerHTML = `<h3>Error</h3><p>Invalid link.</p>`;
                return;
            }

            const orderText = data.o === 'asc' ? 'Smallest ‚ûî Biggest' : 'Biggest ‚ûî Smallest';

            app.innerHTML = `
                <p>Player: <strong>${data.n}</strong></p>
                <p>Your secret number is...</p>
                <div class="big-number">${data.v}</div>
                
                <div style="background:#f1f5f9; padding:15px; border-radius:8px; text-align:left; font-size:0.9rem;">
                    <strong>Instructions:</strong>
                    <ul style="padding-left:20px; margin:5px 0;">
                        <li>Range: ${data.min} - ${data.max}</li>
                        <li>Goal: Rank <b>${orderText}</b></li>
                        <li>Give hints, but do NOT say your number!</li>
                    </ul>
                </div>
            `;
        }


        // --- LOGIC FUNCTIONS ---

        function addPlayer() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            if (!name) return;
            // distinct names
            if (state.players.find(p => p.name === name)) {
                showToast("Name already exists");
                return;
            }
            state.players.push({ name, number: 0 });
            input.value = '';
            renderSetup();
            setTimeout(() => document.getElementById('nameInput').focus(), 50);
        }

        function removePlayer(index) {
            state.players.splice(index, 1);
            renderSetup();
        }

        function startGame() {
            const min = parseInt(document.getElementById('minInput').value);
            const max = parseInt(document.getElementById('maxInput').value);
            const order = document.getElementById('orderInput').value;

            if (min >= max) {
                showToast("Min must be smaller than Max");
                return;
            }

            state.settings = { min, max, order };

            // Generate unique random numbers
            const used = new Set();
            state.players.forEach(p => {
                let num;
                // Safety break to prevent infinite loop if range is too small
                let attempts = 0;
                do {
                    num = Math.floor(Math.random() * (max - min + 1)) + min;
                    attempts++;
                } while (used.has(num) && attempts < 1000);
                
                used.add(num);
                p.number = num;
            });

            setState('DISTRIBUTE');
        }

        function movePlayer(index, direction) {
            // Swap logic
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= state.players.length) return;

            const temp = state.players[index];
            state.players[index] = state.players[targetIndex];
            state.players[targetIndex] = temp;
            
            renderVerify();
        }

        function checkOrder() {
            setState('RESULTS');
        }

        function setState(newState) {
            state.step = newState;
            render();
        }

        // Init
        render();

    </script>
</body>
</html>
